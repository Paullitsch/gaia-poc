<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>GAIA Mission Control</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
:root{
  --bg:#0a0a0f;--surface:#12121a;--surface2:#1a1a26;--border:#2a2a3a;
  --text:#e0e0e8;--text2:#8888a0;--accent:#6366f1;--accent2:#818cf8;
  --green:#22c55e;--red:#ef4444;--yellow:#eab308;--blue:#3b82f6;
  --orange:#f97316;--cyan:#06b6d4;
}
body{background:var(--bg);color:var(--text);font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',system-ui,sans-serif;line-height:1.5;min-height:100vh}
a{color:var(--accent2)}

/* Auth overlay */
#auth-overlay{position:fixed;inset:0;background:var(--bg);z-index:1000;display:flex;align-items:center;justify-content:center;flex-direction:column;gap:16px}
#auth-overlay.hidden{display:none}
#auth-overlay h1{font-size:2rem;background:linear-gradient(135deg,var(--accent),var(--cyan));-webkit-background-clip:text;-webkit-text-fill-color:transparent;margin-bottom:8px}
#auth-overlay input{background:var(--surface2);border:1px solid var(--border);border-radius:8px;padding:12px 16px;color:var(--text);font-size:1rem;width:300px;outline:none}
#auth-overlay input:focus{border-color:var(--accent)}
#auth-overlay button{background:var(--accent);color:#fff;border:none;border-radius:8px;padding:10px 32px;font-size:1rem;cursor:pointer}
#auth-overlay button:hover{background:var(--accent2)}
#auth-error{color:var(--red);font-size:.875rem;min-height:1.25rem}

/* Layout */
.container{max-width:1400px;margin:0 auto;padding:16px}

/* Header */
header{display:flex;align-items:center;justify-content:space-between;padding:12px 20px;background:var(--surface);border-bottom:1px solid var(--border);position:sticky;top:0;z-index:100;backdrop-filter:blur(12px)}
.logo{display:flex;align-items:center;gap:10px}
.logo svg{width:28px;height:28px}
.logo h1{font-size:1.125rem;font-weight:700;background:linear-gradient(135deg,var(--accent),var(--cyan));-webkit-background-clip:text;-webkit-text-fill-color:transparent}
.header-right{display:flex;align-items:center;gap:16px;font-size:.8125rem;color:var(--text2)}
.status-dot{width:8px;height:8px;border-radius:50%;display:inline-block;margin-right:4px}
.status-dot.online{background:var(--green);box-shadow:0 0 8px var(--green)}
.status-dot.offline{background:var(--red);box-shadow:0 0 8px var(--red)}

/* Grid */
.grid{display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-top:16px}
@media(max-width:768px){.grid{grid-template-columns:1fr}}
.full-width{grid-column:1/-1}

/* Cards */
.card{background:var(--surface);border:1px solid var(--border);border-radius:12px;overflow:hidden}
.card-header{padding:14px 18px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between}
.card-header h2{font-size:.8125rem;text-transform:uppercase;letter-spacing:.08em;color:var(--text2);font-weight:600}
.card-body{padding:14px 18px}

/* Badges */
.badge{display:inline-block;padding:2px 10px;border-radius:9999px;font-size:.75rem;font-weight:600;text-transform:uppercase}
.badge-idle{background:rgba(34,197,94,.15);color:var(--green)}
.badge-busy{background:rgba(234,179,8,.15);color:var(--yellow)}
.badge-offline{background:rgba(239,68,68,.15);color:var(--red)}
.badge-queued{background:rgba(99,102,241,.15);color:var(--accent2)}
.badge-running{background:rgba(6,182,212,.15);color:var(--cyan)}
.badge-completed{background:rgba(34,197,94,.15);color:var(--green)}
.badge-failed{background:rgba(239,68,68,.15);color:var(--red)}
.badge-timed_out{background:rgba(249,115,22,.15);color:var(--orange)}

/* Worker cards */
.worker-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:12px}
.worker-card{background:var(--surface2);border:1px solid var(--border);border-radius:10px;padding:14px 16px;transition:border-color .2s}
.worker-card:hover{border-color:var(--accent)}
.worker-card.busy{border-left:3px solid var(--cyan)}
.worker-card.idle{border-left:3px solid var(--green)}
.worker-card.offline{border-left:3px solid var(--red);opacity:.6}
.worker-name{font-weight:600;font-size:.9375rem;display:flex;align-items:center;justify-content:space-between}
.worker-details{margin-top:8px;font-size:.8125rem;color:var(--text2);display:grid;grid-template-columns:auto 1fr;gap:4px 12px}
.worker-details .label{color:var(--text2)}
.worker-details .value{color:var(--text)}
.worker-pulse{width:8px;height:8px;border-radius:50%;display:inline-block}
.worker-pulse.active{background:var(--green);animation:pulse 2s infinite}
.worker-pulse.stale{background:var(--yellow)}
.worker-pulse.dead{background:var(--red)}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.4}}

/* Job list */
.job-section-title{font-size:.8125rem;font-weight:600;color:var(--text2);margin:12px 0 6px;display:flex;align-items:center;gap:6px}
.job-section-title:first-child{margin-top:0}
.job-item{display:flex;align-items:center;justify-content:space-between;padding:8px 12px;background:var(--surface2);border-radius:8px;margin-bottom:6px;font-size:.8125rem}
.job-item .job-left{display:flex;align-items:center;gap:10px}
.job-item .job-id{font-family:'SF Mono',Consolas,monospace;color:var(--text2)}
.job-item .job-method{font-weight:500}
.job-progress{display:flex;align-items:center;gap:8px}
.progress-bar{width:80px;height:4px;background:var(--border);border-radius:2px;overflow:hidden}
.progress-bar .fill{height:100%;border-radius:2px;background:linear-gradient(90deg,var(--accent),var(--cyan));transition:width .3s}

/* Tables (fallback) */
table{width:100%;border-collapse:collapse;font-size:.8125rem}
th{text-align:left;color:var(--text2);font-weight:500;padding:6px 8px;border-bottom:1px solid var(--border)}
td{padding:6px 8px;border-bottom:1px solid rgba(42,42,58,.5)}
tr:last-child td{border-bottom:none}

/* Big numbers */
.big-numbers{display:flex;gap:12px;flex-wrap:wrap}
.big-num{flex:1;min-width:110px;background:var(--surface2);border-radius:8px;padding:14px;text-align:center}
.big-num .value{font-size:1.75rem;font-weight:700;font-variant-numeric:tabular-nums}
.big-num .label{font-size:.6875rem;color:var(--text2);margin-top:4px;text-transform:uppercase}
.solved{color:var(--green)!important}

/* Submit form */
.submit-form{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin-top:12px;padding-top:12px;border-top:1px solid var(--border)}
.submit-form select,.submit-form input{background:var(--surface2);border:1px solid var(--border);border-radius:6px;padding:6px 12px;color:var(--text);font-size:.8125rem;outline:none}
.submit-form select:focus,.submit-form input:focus{border-color:var(--accent)}
.submit-form button{background:var(--accent);color:#fff;border:none;border-radius:6px;padding:6px 16px;cursor:pointer;font-size:.8125rem;font-weight:500;transition:background .2s}
.submit-form button:hover{background:var(--accent2)}
.submit-form button:active{transform:scale(.97)}

/* Activity log */
.activity-log{max-height:200px;overflow-y:auto;font-size:.75rem;font-family:'SF Mono',Consolas,monospace}
.activity-log .entry{padding:3px 0;border-bottom:1px solid rgba(42,42,58,.3);display:flex;gap:8px}
.activity-log .time{color:var(--text2);white-space:nowrap;min-width:65px}
.activity-log .msg{color:var(--text)}

/* Chart */
#chart-container{position:relative;width:100%;height:280px}
#chart-container canvas{width:100%!important;height:100%!important}

/* Buttons */
.btn-sm{background:var(--surface2);border:1px solid var(--border);border-radius:6px;padding:3px 10px;color:var(--text2);cursor:pointer;font-size:.6875rem;transition:all .2s}
.btn-sm:hover{background:var(--border);color:var(--text)}

/* Empty state */
.empty{color:var(--text2);text-align:center;padding:20px;font-size:.8125rem}

/* Scrollbar */
::-webkit-scrollbar{width:5px}
::-webkit-scrollbar-track{background:transparent}
::-webkit-scrollbar-thumb{background:var(--border);border-radius:3px}

/* Tooltip */
.tooltip{position:absolute;background:var(--surface);border:1px solid var(--border);border-radius:6px;padding:8px 12px;font-size:.75rem;pointer-events:none;z-index:10;box-shadow:0 4px 12px rgba(0,0,0,.4)}
</style>
</head>
<body>

<div id="auth-overlay">
  <svg width="48" height="48" viewBox="0 0 32 32" fill="none"><circle cx="16" cy="16" r="14" stroke="url(#g)" stroke-width="2"/><path d="M10 16l4 4 8-8" stroke="url(#g)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><defs><linearGradient id="g" x1="0" y1="0" x2="32" y2="32"><stop stop-color="#6366f1"/><stop offset="1" stop-color="#06b6d4"/></linearGradient></defs></svg>
  <h1>GAIA Mission Control</h1>
  <input type="password" id="token-input" placeholder="Enter auth token" autofocus>
  <div id="auth-error"></div>
  <button onclick="authenticate()">Connect</button>
</div>

<header>
  <div class="logo">
    <svg viewBox="0 0 32 32" fill="none"><circle cx="16" cy="16" r="14" stroke="url(#g2)" stroke-width="2"/><path d="M10 16l4 4 8-8" stroke="url(#g2)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><defs><linearGradient id="g2" x1="0" y1="0" x2="32" y2="32"><stop stop-color="#6366f1"/><stop offset="1" stop-color="#06b6d4"/></linearGradient></defs></svg>
    <h1>GAIA Mission Control</h1>
  </div>
  <div class="header-right">
    <span>Uptime: <strong id="uptime">‚Äî</strong></span>
    <span><span class="status-dot" id="conn-dot"></span><span id="conn-text">Connecting‚Ä¶</span></span>
  </div>
</header>

<div class="container">
  <div class="grid">

    <!-- Workers -->
    <div class="card">
      <div class="card-header"><h2>‚ö° Workers</h2><span id="worker-count" class="badge badge-idle">0</span></div>
      <div class="card-body" id="workers-body"><div class="empty">No workers connected</div></div>
    </div>

    <!-- Jobs -->
    <div class="card">
      <div class="card-header"><h2>üî¨ Jobs</h2><span id="job-count" class="badge badge-queued">0</span></div>
      <div class="card-body" id="jobs-body">
        <div class="empty">No jobs yet</div>
      </div>
    </div>

    <!-- Results Chart -->
    <div class="card full-width">
      <div class="card-header"><h2>üìä Training Progress</h2><span id="result-info" style="font-size:.75rem;color:var(--text2)"></span></div>
      <div class="card-body">
        <div class="big-numbers" id="best-scores"></div>
        <div id="chart-container" style="margin-top:12px"><canvas id="chart"></canvas></div>
      </div>
    </div>

    <!-- Activity Log -->
    <div class="card full-width">
      <div class="card-header"><h2>üìã Activity</h2><button class="btn-sm" onclick="activityLog.length=0;renderActivity()">Clear</button></div>
      <div class="card-body"><div class="activity-log" id="activity-log"><div class="empty">Waiting for events‚Ä¶</div></div></div>
    </div>

  </div>
</div>

<script>
let TOKEN = '';
let serverStart = null;
const activityLog = [];
const MAX_LOG = 100;

function authenticate() {
  TOKEN = document.getElementById('token-input').value.trim();
  if (!TOKEN) { document.getElementById('auth-error').textContent = 'Token required'; return; }
  fetch('/api/status', { headers: { 'Authorization': 'Bearer ' + TOKEN } })
    .then(r => { if (!r.ok) throw new Error('Invalid token'); return r.json(); })
    .then(() => {
      document.getElementById('auth-overlay').classList.add('hidden');
      localStorage.setItem('gaia_token', TOKEN);
      startPolling();
    })
    .catch(() => { document.getElementById('auth-error').textContent = 'Connection failed ‚Äî check token'; });
}

// Enter key on token input
document.getElementById('token-input').addEventListener('keydown', e => { if (e.key === 'Enter') authenticate(); });

// Auto-login from localStorage
window.addEventListener('DOMContentLoaded', () => {
  const saved = localStorage.getItem('gaia_token');
  if (saved) { TOKEN = saved; document.getElementById('token-input').value = saved; authenticate(); }
});

function startPolling() { refresh(); setInterval(refresh, 3000); }

function addActivity(msg) {
  const now = new Date().toLocaleTimeString('en-US', { hour12: false, hour: '2-digit', minute: '2-digit', second: '2-digit' });
  activityLog.unshift({ time: now, msg });
  if (activityLog.length > MAX_LOG) activityLog.pop();
}

let prevWorkerIds = new Set();
let prevJobStatuses = {};

function esc(s) { const d = document.createElement('div'); d.textContent = s || ''; return d.innerHTML; }

function timeSince(iso) {
  if (!iso) return '‚Äî';
  const s = Math.floor((Date.now() - new Date(iso).getTime()) / 1000);
  if (s < 0) return 'just now';
  if (s < 60) return s + 's ago';
  if (s < 3600) return Math.floor(s/60) + 'm ago';
  if (s < 86400) return Math.floor(s/3600) + 'h ago';
  return Math.floor(s/86400) + 'd ago';
}

function duration(startIso, endIso) {
  if (!startIso) return '‚Äî';
  const start = new Date(startIso).getTime();
  const end = endIso ? new Date(endIso).getTime() : Date.now();
  const s = Math.floor((end - start) / 1000);
  if (s < 60) return s + 's';
  if (s < 3600) return Math.floor(s/60) + 'm ' + (s%60) + 's';
  return Math.floor(s/3600) + 'h ' + Math.floor((s%3600)/60) + 'm';
}

async function refresh() {
  try {
    const r = await fetch('/api/status', { headers: { 'Authorization': 'Bearer ' + TOKEN } });
    if (!r.ok) throw new Error('Failed');
    const d = await r.json();

    document.getElementById('conn-dot').className = 'status-dot online';
    document.getElementById('conn-text').textContent = 'Connected';

    if (d.server_start_time) serverStart = new Date(d.server_start_time);
    if (serverStart) {
      const diff = Math.floor((Date.now() - serverStart.getTime()) / 1000);
      const h = Math.floor(diff/3600), m = Math.floor((diff%3600)/60);
      document.getElementById('uptime').textContent = h > 0 ? `${h}h ${m}m` : `${m}m`;
    }

    // Activity detection
    const currentWorkerIds = new Set((d.workers||[]).map(w => w.id));
    for (const w of (d.workers||[])) {
      if (!prevWorkerIds.has(w.id)) addActivity(`üü¢ Worker <strong>${esc(w.name)}</strong> connected`);
    }
    for (const id of prevWorkerIds) {
      if (!currentWorkerIds.has(id)) addActivity(`üî¥ Worker disconnected`);
    }
    prevWorkerIds = currentWorkerIds;

    for (const j of (d.jobs||[])) {
      const prev = prevJobStatuses[j.id];
      if (!prev && j.status === 'queued') addActivity(`üì§ Job <strong>${j.id.slice(0,8)}</strong> queued (${esc(j.method)})`);
      if (prev !== j.status) {
        if (j.status === 'running') addActivity(`‚ñ∂Ô∏è Job <strong>${j.id.slice(0,8)}</strong> running`);
        if (j.status === 'completed') addActivity(`‚úÖ Job <strong>${j.id.slice(0,8)}</strong> completed`);
        if (j.status === 'failed') addActivity(`‚ùå Job <strong>${j.id.slice(0,8)}</strong> failed`);
      }
      prevJobStatuses[j.id] = j.status;
    }

    renderWorkers(d.workers || []);
    renderJobs(d.jobs || [], d.queue_length || 0);
    renderActivity();
    await fetchAndRenderChart(d.jobs || []);

  } catch(e) {
    document.getElementById('conn-dot').className = 'status-dot offline';
    document.getElementById('conn-text').textContent = 'Disconnected';
  }
}

function renderWorkers(workers) {
  const el = document.getElementById('workers-body');
  const online = workers.filter(w => {
    const age = (Date.now() - new Date(w.last_heartbeat).getTime()) / 1000;
    return age < 60;
  });
  document.getElementById('worker-count').textContent = `${online.length}/${workers.length}`;

  if (!workers.length) { el.innerHTML = '<div class="empty">No workers connected<br><span style="font-size:.75rem;color:var(--text2)">Start a worker: <code>gaia-worker --server URL --token TOKEN</code></span></div>'; return; }

  let html = '<div class="worker-grid">';
  for (const w of workers) {
    const hbAge = (Date.now() - new Date(w.last_heartbeat).getTime()) / 1000;
    const pulseClass = hbAge < 15 ? 'active' : hbAge < 60 ? 'stale' : 'dead';
    const stClass = w.status === 'busy' ? 'busy' : hbAge > 60 ? 'offline' : 'idle';
    const gpu = w.gpu && typeof w.gpu === 'object' ? w.gpu.name : (w.gpu || 'CPU only');

    html += `<div class="worker-card ${stClass}">
      <div class="worker-name">
        <span><span class="worker-pulse ${pulseClass}"></span> ${esc(w.name)}</span>
        <span class="badge badge-${stClass}">${stClass}</span>
      </div>
      <div class="worker-details">
        <span class="label">GPU:</span><span class="value">${esc(gpu)}</span>
        <span class="label">Heartbeat:</span><span class="value">${timeSince(w.last_heartbeat)}</span>
        <span class="label">Connected:</span><span class="value">${timeSince(w.registered_at)}</span>`;
    if (w.current_job) {
      html += `<span class="label">Job:</span><span class="value" style="color:var(--cyan)">${w.current_job.slice(0,8)}‚Ä¶</span>`;
    }
    html += `</div></div>`;
  }
  html += '</div>';
  el.innerHTML = html;
}

function renderJobs(jobs, queueLen) {
  const el = document.getElementById('jobs-body');
  document.getElementById('job-count').textContent = jobs.length;

  const running = jobs.filter(j => j.status === 'running');
  const queued = jobs.filter(j => j.status === 'queued');
  const done = jobs.filter(j => ['completed','failed','timed_out'].includes(j.status));

  let html = '';

  if (running.length) {
    html += '<div class="job-section-title"><span style="color:var(--cyan)">‚ñ∂</span> Running</div>';
    for (const j of running) {
      const evals = j.params?.max_evals || j.max_evals || '?';
      html += `<div class="job-item" style="border-left:2px solid var(--cyan)">
        <div class="job-left">
          <span class="job-id">${j.id.slice(0,8)}</span>
          <span class="job-method">${esc(j.method)}</span>
        </div>
        <div class="job-progress">
          <span style="color:var(--text2);font-size:.75rem">${duration(j.started_at)}</span>
          <span class="badge badge-running">running</span>
        </div>
      </div>`;
    }
  }

  if (queued.length) {
    html += `<div class="job-section-title"><span style="color:var(--accent2)">‚è≥</span> Queued (${queued.length})</div>`;
    for (const j of queued) {
      const evals = j.params?.max_evals || j.max_evals || '?';
      html += `<div class="job-item">
        <div class="job-left">
          <span class="job-id">${j.id.slice(0,8)}</span>
          <span class="job-method">${esc(j.method)}</span>
          <span style="color:var(--text2)">${evals} evals</span>
        </div>
        <span class="badge badge-queued">queued</span>
      </div>`;
    }
  }

  if (done.length) {
    html += `<div class="job-section-title"><span style="color:var(--text2)">‚úì</span> History</div>`;
    for (const j of done.slice(0, 10)) {
      const evals = j.params?.max_evals || j.max_evals || '?';
      html += `<div class="job-item">
        <div class="job-left">
          <span class="job-id">${j.id.slice(0,8)}</span>
          <span class="job-method">${esc(j.method)}</span>
          <span style="color:var(--text2)">${duration(j.started_at, j.completed_at)}</span>
        </div>
        <div style="display:flex;align-items:center;gap:6px">
          <span class="badge badge-${j.status}">${j.status}</span>
        </div>
      </div>`;
    }
    if (done.length > 10) html += `<div style="font-size:.75rem;color:var(--text2);text-align:center;padding:4px">+${done.length-10} more</div>`;
  }

  if (!jobs.length) html = '<div class="empty">No jobs yet</div>';

  html += `<div class="submit-form">
    <select id="method-select">
      <option value="cma_es">CMA-ES</option>
      <option value="openai_es">OpenAI-ES</option>
      <option value="hybrid_ff">Hybrid FF+Evo</option>
      <option value="curriculum">Curriculum</option>
      <option value="indirect">Indirect Encoding</option>
    </select>
    <input type="number" id="max-evals-input" value="5000" min="100" step="1000" style="width:90px" placeholder="Evals">
    <button onclick="submitJob()">Submit ‚ö°</button>
  </div>`;
  el.innerHTML = html;
}

function renderActivity() {
  const el = document.getElementById('activity-log');
  if (!activityLog.length) { el.innerHTML = '<div class="empty">Waiting for events‚Ä¶</div>'; return; }
  el.innerHTML = activityLog.slice(0, 30).map(e => `<div class="entry"><span class="time">${e.time}</span><span class="msg">${e.msg}</span></div>`).join('');
}

// Chart
const COLORS = ['#6366f1','#06b6d4','#22c55e','#eab308','#f97316','#ec4899','#ef4444'];
let chartData = {};

async function fetchAndRenderChart(jobs) {
  const interesting = jobs.filter(j => j.status === 'running' || j.status === 'completed');
  let totalResults = 0;

  for (const j of interesting) {
    try {
      const r = await fetch(`/api/results/${j.id}`, { headers: { 'Authorization': 'Bearer ' + TOKEN } });
      if (!r.ok) continue;
      const d = await r.json();
      const points = (d.results || []).map(row => ({
        gen: row.generation,
        best: parseFloat(row.data?.best || row.data?.best_ever || row.data?.score || 0),
        best_ever: parseFloat(row.data?.best_ever || row.data?.best || 0),
        mean: parseFloat(row.data?.mean || 0),
        sigma: parseFloat(row.data?.sigma || 0),
        evals: parseInt(row.data?.evals || 0),
      })).sort((a,b) => a.gen - b.gen);
      chartData[j.id] = { method: j.method, points, status: j.status };
      totalResults += points.length;
    } catch(e) {}
  }

  document.getElementById('result-info').textContent = totalResults > 0 ? `${totalResults} data points` : '';
  drawChart();
  renderBestScores();
}

function renderBestScores() {
  const el = document.getElementById('best-scores');
  const methods = {};
  for (const [id, d] of Object.entries(chartData)) {
    if (!d.points.length) continue;
    const best = Math.max(...d.points.map(p => p.best_ever));
    if (!methods[d.method] || best > methods[d.method]) methods[d.method] = best;
  }
  if (!Object.keys(methods).length) { el.innerHTML = ''; return; }
  el.innerHTML = Object.entries(methods).map(([m, s]) => {
    const solved = s >= 200;
    return `<div class="big-num"><div class="value ${solved?'solved':''}">${s.toFixed(1)}</div><div class="label">${esc(m)}${solved?' üéâ SOLVED':''}</div></div>`;
  }).join('');
}

function drawChart() {
  const canvas = document.getElementById('chart');
  const container = document.getElementById('chart-container');
  const dpr = window.devicePixelRatio || 1;
  const w = container.clientWidth;
  const h = container.clientHeight;
  canvas.width = w * dpr;
  canvas.height = h * dpr;
  canvas.style.width = w + 'px';
  canvas.style.height = h + 'px';

  const ctx = canvas.getContext('2d');
  ctx.scale(dpr, dpr);
  ctx.clearRect(0, 0, w, h);

  const allPoints = Object.values(chartData).flatMap(d => d.points);
  if (!allPoints.length) {
    ctx.fillStyle = '#8888a0';
    ctx.font = '13px sans-serif';
    ctx.textAlign = 'center';
    ctx.fillText('Submit a job to see training progress', w/2, h/2);
    return;
  }

  const pad = { top: 24, right: 20, bottom: 36, left: 56 };
  const pw = w - pad.left - pad.right;
  const ph = h - pad.top - pad.bottom;

  const maxGen = Math.max(...allPoints.map(p => p.gen), 1);
  const scores = allPoints.map(p => p.best_ever);
  const maxScore = Math.max(Math.max(...scores), 250);
  const minScore = Math.min(Math.min(...scores), -300);
  const scoreRange = maxScore - minScore || 1;

  const toX = gen => pad.left + (gen / maxGen) * pw;
  const toY = score => pad.top + ph - ((score - minScore) / scoreRange) * ph;

  // Grid lines
  ctx.strokeStyle = '#1a1a26';
  ctx.lineWidth = 0.5;
  const gridSteps = 6;
  for (let i = 0; i <= gridSteps; i++) {
    const y = pad.top + (ph / gridSteps) * i;
    ctx.beginPath(); ctx.moveTo(pad.left, y); ctx.lineTo(w - pad.right, y); ctx.stroke();
    const val = maxScore - (scoreRange / gridSteps) * i;
    ctx.fillStyle = '#666680';
    ctx.font = '10px sans-serif';
    ctx.textAlign = 'right';
    ctx.fillText(val.toFixed(0), pad.left - 6, y + 3);
  }

  // X axis
  ctx.textAlign = 'center';
  ctx.fillStyle = '#666680';
  for (let i = 0; i <= 4; i++) {
    const gen = Math.round((maxGen / 4) * i);
    ctx.fillText(gen, toX(gen), h - pad.bottom + 16);
  }
  ctx.fillText('Generation', w / 2, h - 2);

  // Solved threshold (200)
  if (200 >= minScore && 200 <= maxScore) {
    ctx.setLineDash([4, 3]);
    ctx.strokeStyle = '#22c55e40';
    ctx.lineWidth = 1;
    ctx.beginPath(); ctx.moveTo(pad.left, toY(200)); ctx.lineTo(w - pad.right, toY(200)); ctx.stroke();
    ctx.setLineDash([]);
    ctx.fillStyle = '#22c55e60';
    ctx.font = '9px sans-serif';
    ctx.textAlign = 'left';
    ctx.fillText('SOLVED (200)', pad.left + 4, toY(200) - 3);
  }

  // Zero line
  if (0 >= minScore && 0 <= maxScore) {
    ctx.setLineDash([2, 2]);
    ctx.strokeStyle = '#ffffff15';
    ctx.lineWidth = 0.5;
    ctx.beginPath(); ctx.moveTo(pad.left, toY(0)); ctx.lineTo(w - pad.right, toY(0)); ctx.stroke();
    ctx.setLineDash([]);
  }

  // Draw lines
  let ci = 0;
  const legend = [];
  for (const [id, d] of Object.entries(chartData)) {
    if (!d.points.length) continue;
    const color = COLORS[ci % COLORS.length];
    legend.push({ method: d.method, color, status: d.status });

    // Area fill
    ctx.fillStyle = color + '10';
    ctx.beginPath();
    ctx.moveTo(toX(d.points[0].gen), toY(minScore));
    d.points.forEach(p => ctx.lineTo(toX(p.gen), toY(p.best_ever)));
    ctx.lineTo(toX(d.points[d.points.length-1].gen), toY(minScore));
    ctx.closePath();
    ctx.fill();

    // Line
    ctx.strokeStyle = color;
    ctx.lineWidth = 2;
    ctx.beginPath();
    d.points.forEach((p, i) => { i === 0 ? ctx.moveTo(toX(p.gen), toY(p.best_ever)) : ctx.lineTo(toX(p.gen), toY(p.best_ever)); });
    ctx.stroke();

    // End dot
    const last = d.points[d.points.length - 1];
    ctx.fillStyle = color;
    ctx.beginPath();
    ctx.arc(toX(last.gen), toY(last.best_ever), 3, 0, Math.PI * 2);
    ctx.fill();

    // End label
    ctx.fillStyle = color;
    ctx.font = 'bold 10px sans-serif';
    ctx.textAlign = 'left';
    ctx.fillText(last.best_ever.toFixed(1), toX(last.gen) + 6, toY(last.best_ever) + 3);

    ci++;
  }

  // Legend
  ctx.font = '10px sans-serif';
  let lx = pad.left;
  for (const l of legend) {
    ctx.fillStyle = l.color;
    ctx.fillRect(lx, pad.top - 16, 10, 3);
    ctx.fillStyle = '#c0c0d0';
    ctx.textAlign = 'left';
    const label = l.method + (l.status === 'running' ? ' ‚óè' : '');
    ctx.fillText(label, lx + 14, pad.top - 10);
    lx += ctx.measureText(label).width + 30;
  }
}

window.addEventListener('resize', drawChart);

async function submitJob() {
  const method = document.getElementById('method-select').value;
  const maxEvals = parseInt(document.getElementById('max-evals-input').value) || 5000;
  try {
    const r = await fetch('/api/jobs/submit', {
      method: 'POST',
      headers: { 'Authorization': 'Bearer ' + TOKEN, 'Content-Type': 'application/json' },
      body: JSON.stringify({ method, params: { max_evals: maxEvals } })
    });
    if (r.ok) {
      addActivity(`üì§ Submitted: <strong>${esc(method)}</strong> (${maxEvals} evals)`);
      refresh();
    }
  } catch(e) { addActivity('‚ùå Failed to submit job'); }
}
</script>
</body>
</html>
