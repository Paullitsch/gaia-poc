<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>GAIA Mission Control</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
:root{
  --bg:#0a0a0f;--surface:#12121a;--surface2:#1a1a26;--border:#2a2a3a;
  --text:#e0e0e8;--text2:#8888a0;--accent:#6366f1;--accent2:#818cf8;
  --green:#22c55e;--red:#ef4444;--yellow:#eab308;--blue:#3b82f6;
  --orange:#f97316;--cyan:#06b6d4;
}
body{background:var(--bg);color:var(--text);font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',system-ui,sans-serif;line-height:1.5;min-height:100vh}

/* Auth */
#auth-overlay{position:fixed;inset:0;background:var(--bg);z-index:1000;display:flex;align-items:center;justify-content:center;flex-direction:column;gap:16px}
#auth-overlay.hidden{display:none}
#auth-overlay h1{font-size:2rem;background:linear-gradient(135deg,var(--accent),var(--cyan));-webkit-background-clip:text;-webkit-text-fill-color:transparent}
#auth-overlay input{background:var(--surface2);border:1px solid var(--border);border-radius:8px;padding:12px 16px;color:var(--text);font-size:1rem;width:300px;outline:none}
#auth-overlay input:focus{border-color:var(--accent)}
#auth-overlay button{background:var(--accent);color:#fff;border:none;border-radius:8px;padding:10px 32px;font-size:1rem;cursor:pointer}
#auth-error{color:var(--red);font-size:.875rem;min-height:1.25rem}

.container{max-width:1440px;margin:0 auto;padding:16px}

/* Header */
header{display:flex;align-items:center;justify-content:space-between;padding:10px 20px;background:var(--surface);border-bottom:1px solid var(--border);position:sticky;top:0;z-index:100}
.logo{display:flex;align-items:center;gap:10px}
.logo svg{width:26px;height:26px}
.logo h1{font-size:1.05rem;font-weight:700;background:linear-gradient(135deg,var(--accent),var(--cyan));-webkit-background-clip:text;-webkit-text-fill-color:transparent}
.header-right{display:flex;align-items:center;gap:16px;font-size:.8rem;color:var(--text2)}
.dot{width:7px;height:7px;border-radius:50%;display:inline-block;margin-right:4px}
.dot.on{background:var(--green);box-shadow:0 0 6px var(--green)}
.dot.off{background:var(--red)}

/* Tabs */
.tabs{display:flex;gap:0;margin-top:16px;border-bottom:1px solid var(--border)}
.tab{padding:8px 20px;font-size:.8125rem;color:var(--text2);cursor:pointer;border-bottom:2px solid transparent;font-weight:500;transition:all .2s}
.tab:hover{color:var(--text)}
.tab.active{color:var(--accent2);border-bottom-color:var(--accent)}
.tab-content{display:none}
.tab-content.active{display:block}

/* Grid */
.grid{display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-top:16px}
@media(max-width:768px){.grid{grid-template-columns:1fr}}
.full-width{grid-column:1/-1}

/* Cards */
.card{background:var(--surface);border:1px solid var(--border);border-radius:12px;overflow:hidden}
.card-header{padding:12px 16px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between}
.card-header h2{font-size:.8rem;text-transform:uppercase;letter-spacing:.06em;color:var(--text2);font-weight:600}
.card-body{padding:14px 16px}

/* Badges */
.badge{display:inline-block;padding:2px 8px;border-radius:9999px;font-size:.7rem;font-weight:600;text-transform:uppercase}
.badge-idle{background:rgba(34,197,94,.12);color:var(--green)}
.badge-busy{background:rgba(234,179,8,.12);color:var(--yellow)}
.badge-offline{background:rgba(239,68,68,.12);color:var(--red)}
.badge-queued{background:rgba(99,102,241,.12);color:var(--accent2)}
.badge-running{background:rgba(6,182,212,.12);color:var(--cyan)}
.badge-completed{background:rgba(34,197,94,.12);color:var(--green)}
.badge-failed{background:rgba(239,68,68,.12);color:var(--red)}
.badge-timed_out{background:rgba(249,115,22,.12);color:var(--orange)}
.badge-cancelled{background:rgba(136,136,160,.12);color:var(--text2)}

/* Worker cards */
.worker-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:10px}
.worker-card{background:var(--surface2);border:1px solid var(--border);border-radius:10px;padding:12px 14px}
.worker-card.busy{border-left:3px solid var(--cyan)}
.worker-card.idle{border-left:3px solid var(--green)}
.worker-name{font-weight:600;font-size:.875rem;display:flex;align-items:center;justify-content:space-between}
.worker-details{margin-top:6px;font-size:.75rem;color:var(--text2);display:grid;grid-template-columns:auto 1fr;gap:3px 10px}
.worker-details .v{color:var(--text)}
.pulse{width:7px;height:7px;border-radius:50%;display:inline-block}
.pulse.live{background:var(--green);animation:pulse 2s infinite}
.pulse.stale{background:var(--yellow)}
.pulse.dead{background:var(--red)}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.4}}

/* Job items */
.job-section{font-size:.75rem;font-weight:600;color:var(--text2);margin:10px 0 4px;display:flex;align-items:center;gap:6px}
.job-section:first-child{margin-top:0}
.job-item{display:flex;align-items:center;justify-content:space-between;padding:7px 10px;background:var(--surface2);border-radius:7px;margin-bottom:5px;font-size:.8rem}
.job-left{display:flex;align-items:center;gap:8px}
.job-id{font-family:monospace;color:var(--text2);font-size:.75rem}

/* Big numbers */
.big-numbers{display:flex;gap:10px;flex-wrap:wrap}
.big-num{flex:1;min-width:100px;background:var(--surface2);border-radius:8px;padding:12px;text-align:center}
.big-num .val{font-size:1.5rem;font-weight:700;font-variant-numeric:tabular-nums}
.big-num .lbl{font-size:.65rem;color:var(--text2);margin-top:2px;text-transform:uppercase}
.solved{color:var(--green)!important}

/* Charts */
.chart-wrap{position:relative;width:100%;height:320px;margin-top:10px}
.chart-wrap canvas{width:100%!important;height:100%!important}

/* Submit form */
.submit-form{display:flex;gap:6px;align-items:center;flex-wrap:wrap;margin-top:10px;padding-top:10px;border-top:1px solid var(--border)}
.submit-form select,.submit-form input{background:var(--surface2);border:1px solid var(--border);border-radius:6px;padding:5px 10px;color:var(--text);font-size:.8rem;outline:none}
.submit-form button{background:var(--accent);color:#fff;border:none;border-radius:6px;padding:5px 14px;cursor:pointer;font-size:.8rem;font-weight:500}
.submit-form button:hover{background:var(--accent2)}

/* Toolbar */
.toolbar{display:flex;gap:6px;align-items:center;flex-wrap:wrap}
.btn-sm{background:var(--surface2);border:1px solid var(--border);border-radius:5px;padding:3px 10px;color:var(--text2);cursor:pointer;font-size:.7rem}
.btn-sm:hover{background:var(--border);color:var(--text)}
.btn-sm.active{background:var(--accent);color:#fff;border-color:var(--accent)}

/* Activity */
.activity-log{max-height:180px;overflow-y:auto;font-size:.7rem;font-family:monospace}
.activity-log .entry{padding:2px 0;border-bottom:1px solid rgba(42,42,58,.3);display:flex;gap:8px}
.activity-log .time{color:var(--text2);min-width:60px}

/* Empty */
.empty{color:var(--text2);text-align:center;padding:20px;font-size:.8rem}

/* Env tabs */
.env-tabs{display:flex;gap:0;margin-bottom:12px;border-bottom:1px solid var(--border)}
.env-tab{padding:6px 16px;font-size:.75rem;color:var(--text2);cursor:pointer;border-bottom:2px solid transparent;font-weight:500;transition:all .2s}
.env-tab:hover{color:var(--text)}
.env-tab.active{color:var(--cyan);border-bottom-color:var(--cyan)}

/* Leaderboard table */
.leaderboard{width:100%;border-collapse:collapse;font-size:.8rem}
.leaderboard th{text-align:left;padding:6px 10px;color:var(--text2);font-size:.7rem;text-transform:uppercase;border-bottom:1px solid var(--border)}
.leaderboard td{padding:6px 10px;border-bottom:1px solid rgba(42,42,58,.3)}
.leaderboard tr:hover{background:rgba(99,102,241,.05)}
.rank-1{color:var(--yellow);font-weight:700}
.rank-2{color:#c0c0c0;font-weight:600}
.rank-3{color:#cd7f32;font-weight:600}

/* Scrollbar */
::-webkit-scrollbar{width:4px}
::-webkit-scrollbar-thumb{background:var(--border);border-radius:2px}
</style>
</head>
<body>

<div id="auth-overlay">
  <svg width="48" height="48" viewBox="0 0 32 32" fill="none"><circle cx="16" cy="16" r="14" stroke="url(#g)" stroke-width="2"/><path d="M10 16l4 4 8-8" stroke="url(#g)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><defs><linearGradient id="g" x1="0" y1="0" x2="32" y2="32"><stop stop-color="#6366f1"/><stop offset="1" stop-color="#06b6d4"/></linearGradient></defs></svg>
  <h1>GAIA Mission Control</h1>
  <input type="password" id="token-input" placeholder="Enter auth token" autofocus>
  <div id="auth-error"></div>
  <button onclick="authenticate()">Connect</button>
</div>

<header>
  <div class="logo">
    <svg viewBox="0 0 32 32" fill="none"><circle cx="16" cy="16" r="14" stroke="url(#g2)" stroke-width="2"/><path d="M10 16l4 4 8-8" stroke="url(#g2)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><defs><linearGradient id="g2" x1="0" y1="0" x2="32" y2="32"><stop stop-color="#6366f1"/><stop offset="1" stop-color="#06b6d4"/></linearGradient></defs></svg>
    <h1>GAIA Mission Control</h1>
  </div>
  <div class="header-right">
    <span>‚è± <strong id="uptime">‚Äî</strong></span>
    <span><span class="dot" id="conn-dot"></span><span id="conn-text">‚Ä¶</span></span>
  </div>
</header>

<div class="container">
  <div class="tabs">
    <div class="tab active" data-tab="benchmarks">üèÜ Benchmarks</div>
    <div class="tab" data-tab="overview">Overview</div>
    <div class="tab" data-tab="charts">Charts</div>
    <div class="tab" data-tab="history">üìã History</div>
    <div class="tab" data-tab="debug">Debug</div>
    <div class="tab" data-tab="network">üåê Network</div>
  </div>

  <!-- TAB: Benchmarks (NEW MAIN TAB) -->
  <div class="tab-content active" id="tab-benchmarks">
    <div class="grid">
      <!-- Submit Job -->
      <div class="card full-width">
        <div class="card-header"><h2>‚ö° Submit Experiment</h2></div>
        <div class="card-body">
          <div class="submit-form" style="margin-top:0;padding-top:0;border-top:none">
            <select id="env-select">
              <option value="LunarLander-v3">LunarLander-v3</option>
              <option value="BipedalWalker-v3">BipedalWalker-v3</option>
              <option value="BipedalWalkerHardcore-v3">BipedalWalkerHardcore-v3</option>
            </select>
            <select id="method-select">
              <optgroup label="‚ö° Backpropagation (Control)">
                <option value="ppo_baseline">PPO (Backprop) ‚Äî Control Group</option>
                <option value="meta_learning">Meta-Learning (Evolved Rules) üß¨</option>
                <option value="scaling_test">Scaling Test üìè</option>
              </optgroup>
              <optgroup label="üß¨ Gradient-Free (GAIA)">
                <option value="cma_es">CMA-ES</option>
                <option value="openai_es">OpenAI-ES</option>
                <option value="neuromod">Neuromod CMA-ES</option>
                <option value="island_model">Island Model</option>
                <option value="neuromod_island">Neuromod Island</option>
                <option value="curriculum">Curriculum</option>
                <option value="hybrid_cma_ff">Hybrid CMA+FF</option>
                <option value="indirect_encoding">Indirect Encoding</option>
                <option value="island_advanced">Island Advanced</option>
                <option value="scaling">Network Scaling</option>
              </optgroup>
            </select>
            <input type="number" id="max-evals-input" value="5000" min="100" step="1000" style="width:90px" placeholder="Max evals">
            <button onclick="submitJob()">Submit ‚ö°</button>
          </div>
        </div>
      </div>

      <!-- Benchmark Leaderboards -->
      <div class="card full-width">
        <div class="card-header"><h2>üèÜ Leaderboards</h2></div>
        <div class="card-body">
          <div class="env-tabs" id="bench-env-tabs">
            <div class="env-tab active" data-env="LunarLander-v3">üöÄ LunarLander-v3</div>
            <div class="env-tab" data-env="BipedalWalker-v3">ü¶ø BipedalWalker-v3</div>
            <div class="env-tab" data-env="BipedalWalkerHardcore-v3">üî• BipedalWalkerHardcore-v3</div>
          </div>
          <div id="leaderboard-body"><div class="empty">Run experiments to see leaderboards</div></div>
        </div>
      </div>

      <!-- Learning Curves per Environment -->
      <div class="card full-width">
        <div class="card-header">
          <h2>üìà Learning Curves</h2>
          <div class="toolbar">
            <button class="btn-sm active" data-metric="best_ever" onclick="setMetric(this,'best_ever')">Best Ever</button>
            <button class="btn-sm" data-metric="mean" onclick="setMetric(this,'mean')">Mean</button>
            <span style="color:var(--text2);font-size:.7rem;margin-left:4px" id="chart1-info"></span>
          </div>
        </div>
        <div class="card-body">
          <div id="method-toggles" style="display:flex;flex-wrap:wrap;gap:6px;margin-bottom:8px;font-size:.75rem"></div>
          <div style="font-size:.65rem;color:var(--text2);margin-bottom:4px">üñ±Ô∏è Scroll to zoom ‚Ä¢ Shift+drag to pan ‚Ä¢ Double-click to reset</div>
          <div class="chart-wrap"><canvas id="learning-canvas"></canvas></div>
        </div>
      </div>
    </div>
  </div>

  <!-- TAB: Overview -->
  <div class="tab-content" id="tab-overview">
    <div class="grid">
      <div class="card">
        <div class="card-header"><h2>‚ö° Workers</h2><div class="toolbar"><label style="font-size:.7rem;color:var(--text2);cursor:pointer;display:flex;align-items:center;gap:4px"><input type="checkbox" id="show-offline" onchange="refresh()" style="accent-color:var(--accent)"> Offline</label><span id="worker-count" class="badge badge-idle">0</span></div></div>
        <div class="card-body" id="workers-body"><div class="empty">No workers connected</div></div>
      </div>
      <div class="card">
        <div class="card-header"><h2>üî¨ Jobs</h2><span id="job-count" class="badge badge-queued">0</span></div>
        <div class="card-body" id="jobs-body"><div class="empty">No jobs yet</div></div>
      </div>
      <div class="card full-width">
        <div class="card-header"><h2>üìä Best Scores</h2></div>
        <div class="card-body"><div class="big-numbers" id="best-scores"><div class="empty">Run experiments to see scores</div></div></div>
      </div>
      <div class="card full-width">
        <div class="card-header"><h2>üìã Activity</h2><button class="btn-sm" onclick="activityLog.length=0;renderActivity()">Clear</button></div>
        <div class="card-body"><div class="activity-log" id="activity-log"><div class="empty">Waiting‚Ä¶</div></div></div>
      </div>
    </div>
  </div>

  <!-- TAB: Charts -->
  <div class="tab-content" id="tab-charts">
    <div class="grid">
      <div class="card">
        <div class="card-header"><h2>üèÜ Method Comparison</h2></div>
        <div class="card-body"><div class="chart-wrap" style="height:280px"><canvas id="comparison-canvas"></canvas></div></div>
      </div>
      <div class="card">
        <div class="card-header"><h2>üî¨ Convergence (œÉ)</h2></div>
        <div class="card-body"><div class="chart-wrap" style="height:280px"><canvas id="sigma-canvas"></canvas></div></div>
      </div>
      <div class="card full-width">
        <div class="card-header"><h2>üìä Score Distribution</h2></div>
        <div class="card-body"><div class="chart-wrap" style="height:260px"><canvas id="dist-canvas"></canvas></div></div>
      </div>
    </div>
  </div>

  <!-- TAB: History -->
  <div class="tab-content" id="tab-history">
    <div class="grid">
      <div class="card full-width">
        <div class="card-header">
          <h2>üìã Job History</h2>
          <div class="toolbar">
            <select id="history-env-filter" onchange="renderHistory()" style="background:var(--surface2);color:var(--text);border:1px solid var(--border);border-radius:4px;padding:4px 8px;font-size:.75rem">
              <option value="all">All Environments</option>
              <option value="LunarLander-v3">LunarLander-v3</option>
              <option value="BipedalWalker-v3">BipedalWalker-v3</option>
              <option value="BipedalWalkerHardcore-v3">BipedalWalkerHardcore-v3</option>
            </select>
            <button class="btn-sm" onclick="downloadAllCSV()">‚¨áÔ∏è Export All CSV</button>
            <button class="btn-sm" onclick="downloadSummaryJSON()">‚¨áÔ∏è Summary JSON</button>
          </div>
        </div>
        <div class="card-body" id="history-body"><div class="empty">No jobs yet</div></div>
      </div>
    </div>
  </div>

  <!-- TAB: Debug -->
  <div class="tab-content" id="tab-debug">
    <div class="grid">
      <div class="card full-width">
        <div class="card-header"><h2>üîç Live Stream</h2><div class="toolbar"><button class="btn-sm" onclick="debugLog.length=0;renderDebug()">Clear</button><label style="font-size:.7rem;color:var(--text2);cursor:pointer;display:flex;align-items:center;gap:4px"><input type="checkbox" id="debug-autoscroll" checked style="accent-color:var(--accent)"> Auto-scroll</label></div></div>
        <div class="card-body"><div id="debug-log" style="max-height:500px;overflow-y:auto;font-family:monospace;font-size:.7rem;white-space:pre-wrap;color:var(--text2)">Waiting for data‚Ä¶</div></div>
      </div>
      <div class="card full-width">
        <div class="card-header"><h2>üì° Raw API Status</h2><button class="btn-sm" onclick="refreshDebugRaw()">Refresh</button></div>
        <div class="card-body"><pre id="debug-raw" style="max-height:400px;overflow:auto;font-size:.7rem;color:var(--text2)">Click Refresh‚Ä¶</pre></div>
      </div>
    </div>
  </div>

  <!-- TAB: Network -->
  <div class="tab-content" id="tab-network">
    <div class="grid">
      <div class="card full-width">
        <div class="card-header"><h2>üåê GAIA P2P Network</h2></div>
        <div class="card-body" id="network-body"><div class="empty">Loading network status...</div></div>
      </div>
      <div class="card full-width">
        <div class="card-header"><h2>üó∫Ô∏è Network Topology</h2></div>
        <div class="card-body"><canvas id="network-canvas" width="800" height="400" style="width:100%;background:var(--surface2);border-radius:8px"></canvas></div>
      </div>
    </div>
  </div>
</div>

<script>
// ======= BENCHMARK CONFIG =======
const BENCHMARKS = {
  'LunarLander-v3':           { threshold: 200, obs_dim: 8,  act_dim: 4, action_type: 'discrete',   emoji: 'üöÄ' },
  'BipedalWalker-v3':         { threshold: 300, obs_dim: 24, act_dim: 4, action_type: 'continuous', emoji: 'ü¶ø' },
  'BipedalWalkerHardcore-v3': { threshold: 300, obs_dim: 24, act_dim: 4, action_type: 'continuous', emoji: 'üî•' },
};

const GENERIC_METHODS = [
  'cma_es','openai_es','neuromod','island_model','neuromod_island',
  'curriculum','hybrid_cma_ff','indirect_encoding','island_advanced',
  'gpu_cma','scaling'
];

const METHOD_NAMES = {
  cma_es:'CMA-ES', openai_es:'OpenAI-ES', hybrid_cma_ff:'Hybrid CMA+FF',
  curriculum:'Curriculum', indirect_encoding:'Indirect Enc',
  neuromod:'Neuromod CMA-ES', island_model:'Island Model',
  island_advanced:'Island Advanced', neuromod_island:'Neuromod Island',
  scaling:'Network Scaling',
  ppo_baseline:'PPO (Backprop)',
};
const BACKPROP_METHODS = new Set(['ppo_baseline']);

function resolveEnv(job) { return job.environment; }

// ======= STATE =======
let TOKEN = '', serverStart = null, currentBenchEnv = 'LunarLander-v3';
const activityLog = [], MAX_LOG = 80;
let prevWorkerIds = new Set(), prevJobStatuses = {};
let allJobData = {}; // { jobId: { method, environment, status, points: [...] } }
let chartZoom = {x0:0, x1:1, dragging:false, startX:0}; // 0..1 range
let hiddenMethods = new Set();
let allJobs = []; // raw jobs from API
let currentMetric = 'best_ever';
const COLORS = ['#6366f1','#06b6d4','#22c55e','#eab308','#f97316','#ec4899','#ef4444','#a855f7','#14b8a6','#f43f5e'];

// ======= AUTH =======
function authenticate(){
  TOKEN=document.getElementById('token-input').value.trim();
  if(!TOKEN){document.getElementById('auth-error').textContent='Token required';return}
  fetch('/api/status',{headers:{'Authorization':'Bearer '+TOKEN}})
    .then(r=>{if(!r.ok)throw 0;return r.json()})
    .then(()=>{document.getElementById('auth-overlay').classList.add('hidden');localStorage.setItem('gaia_token',TOKEN);startPolling()})
    .catch(()=>{document.getElementById('auth-error').textContent='Invalid token'});
}
document.getElementById('token-input').addEventListener('keydown',e=>{if(e.key==='Enter')authenticate()});
window.addEventListener('DOMContentLoaded',()=>{const s=localStorage.getItem('gaia_token');if(s){TOKEN=s;document.getElementById('token-input').value=s;authenticate()}});

// ======= TABS =======
document.querySelectorAll('.tab').forEach(t=>t.addEventListener('click',()=>{
  document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active'));
  document.querySelectorAll('.tab-content').forEach(x=>x.classList.remove('active'));
  t.classList.add('active');
  document.getElementById('tab-'+t.dataset.tab).classList.add('active');
  if(t.dataset.tab==='charts')requestAnimationFrame(drawAllCharts);
  if(t.dataset.tab==='benchmarks')requestAnimationFrame(()=>{renderLeaderboard();drawLearningCurves()});
  if(t.dataset.tab==='history')renderHistory();
}));

// Env tabs
document.querySelectorAll('#bench-env-tabs .env-tab').forEach(t=>t.addEventListener('click',()=>{
  document.querySelectorAll('#bench-env-tabs .env-tab').forEach(x=>x.classList.remove('active'));
  t.classList.add('active');
  currentBenchEnv=t.dataset.env;
  renderLeaderboard();
  drawLearningCurves();
}));

// ======= POLLING =======
function startPolling(){refresh();setInterval(refresh,3000)}

function addLog(m,ts){const d=ts?new Date(ts):new Date();activityLog.unshift({ts:d.getTime(),time:d.toLocaleTimeString('en',{hour12:false,hour:'2-digit',minute:'2-digit',second:'2-digit'}),msg:m});activityLog.sort((a,b)=>b.ts-a.ts);if(activityLog.length>MAX_LOG)activityLog.pop()}
function esc(s){const d=document.createElement('div');d.textContent=s||'';return d.innerHTML}
function timeSince(iso){if(!iso)return'‚Äî';const s=Math.floor((Date.now()-new Date(iso).getTime())/1000);if(s<0)return'now';if(s<60)return s+'s';if(s<3600)return Math.floor(s/60)+'m';if(s<86400)return Math.floor(s/3600)+'h';return Math.floor(s/86400)+'d'}
function dur(a,b){if(!a)return'‚Äî';const s=Math.floor(((b?new Date(b):new Date).getTime()-new Date(a).getTime())/1000);if(s<60)return s+'s';if(s<3600)return Math.floor(s/60)+'m'+s%60+'s';return Math.floor(s/3600)+'h'+Math.floor(s%3600/60)+'m'}
function fmtTime(t){if(!t)return'‚Äî';const d=new Date(t);return d.toLocaleTimeString('de-AT',{hour:'2-digit',minute:'2-digit',second:'2-digit',hour12:false})}

async function refresh(){
  try{
    const r=await fetch('/api/status',{headers:{'Authorization':'Bearer '+TOKEN}});
    if(!r.ok)throw 0;
    const d=await r.json();
    document.getElementById('conn-dot').className='dot on';
    document.getElementById('conn-text').textContent='Connected';
    if(d.server_start_time)serverStart=new Date(d.server_start_time);
    if(serverStart){const s=Math.floor((Date.now()-serverStart)/1000),h=Math.floor(s/3600),m=Math.floor(s%3600/60);document.getElementById('uptime').textContent=h>0?h+'h '+m+'m':m+'m'}
    allJobs=d.jobs||[];

    // Activity tracking
    const cw=new Set((d.workers||[]).map(w=>w.id));
    for(const w of d.workers||[])if(!prevWorkerIds.has(w.id))addLog('üü¢ <b>'+esc(w.name)+'</b> connected',w.registered_at);
    for(const id of prevWorkerIds)if(!cw.has(id))addLog('üî¥ Worker disconnected');
    prevWorkerIds=cw;
    for(const j of d.jobs||[]){const p=prevJobStatuses[j.id];if(!p&&j.status==='queued')addLog('üì§ Job <b>'+j.id.slice(0,8)+'</b> queued ('+esc(j.method)+')',j.created_at);if(p!==j.status){if(j.status==='running')addLog('‚ñ∂Ô∏è Job <b>'+j.id.slice(0,8)+'</b> running',j.started_at);if(j.status==='completed')addLog('‚úÖ Job <b>'+j.id.slice(0,8)+'</b> completed',j.completed_at);if(j.status==='failed')addLog('‚ùå Job <b>'+j.id.slice(0,8)+'</b> failed',j.completed_at)}prevJobStatuses[j.id]=j.status}

    renderWorkers(d.workers||[]);
    renderJobs(d.jobs||[]);
    renderActivity();
    await fetchResults(d.jobs||[]);
    renderBestScores();
    renderLeaderboard();
    if(document.getElementById('tab-benchmarks').classList.contains('active'))drawLearningCurves();
    if(document.getElementById('tab-charts').classList.contains('active'))drawAllCharts();
  }catch(e){document.getElementById('conn-dot').className='dot off';document.getElementById('conn-text').textContent='Disconnected'}
}

// ======= RENDER: Workers =======
function renderWorkers(ws){
  const el=document.getElementById('workers-body');
  const showOffline=document.getElementById('show-offline').checked;
  const on=ws.filter(w=>(Date.now()-new Date(w.last_heartbeat))/1000<60);
  const off=ws.filter(w=>(Date.now()-new Date(w.last_heartbeat))/1000>=60);
  document.getElementById('worker-count').textContent=on.length+' online'+(showOffline&&off.length?' ¬∑ '+off.length+' offline':'');
  const visible=showOffline?ws:on;
  if(!visible.length){el.innerHTML=on.length===0&&off.length===0?'<div class="empty">No workers<br><code style="font-size:.7rem;color:var(--text2)">gaia-worker --server URL --token TOKEN</code></div>':'<div class="empty">All workers offline'+(!showOffline?' ‚Äî enable "Offline" to show':'')+'</div>';return}
  let h='<div class="worker-grid">';
  for(const w of visible){
    const age=(Date.now()-new Date(w.last_heartbeat))/1000;
    const pc=age<15?'live':age<60?'stale':'dead';
    const isOffline=age>=60;
    const sc=isOffline?'offline':w.status==='busy'?'busy':'idle';
    const gpu=w.gpu&&typeof w.gpu==='object'?w.gpu.name:(w.gpu||'CPU');
    const disabled=w.enabled===false;
    const opacity=isOffline||disabled?'opacity:.5':'';
    const statusLabel=disabled?'disabled':sc;
    const ver=w.version?'v'+w.version:'‚Äî';
    h+=`<div class="worker-card ${sc}" style="${opacity}"><div class="worker-name"><span><span class="pulse ${pc}"></span> ${esc(w.name)}</span><div style="display:flex;gap:4px;align-items:center"><span class="badge badge-${sc}">${statusLabel}</span><button class="btn-sm" onclick="toggleWorker('${w.id}')" title="${disabled?'Enable':'Disable'} worker">${disabled?'‚ñ∂':'‚è∏'}</button><button class="btn-sm" onclick="forceUpdate('${w.id}')" title="Force update" style="font-size:.6rem">üîÑ</button></div></div><div class="worker-details"><span>GPU:</span><span class="v">${esc(gpu)}</span><span>Ver:</span><span class="v" style="color:var(--accent2)">${ver}</span><span>HB:</span><span class="v">${timeSince(w.last_heartbeat)}</span><span>Up:</span><span class="v">${timeSince(w.registered_at)}</span>${w.current_job?'<span>Job:</span><span class="v" style="color:var(--cyan)">'+w.current_job.slice(0,8)+'</span>':''}</div></div>`;
  }
  el.innerHTML=h+'</div>';
}

// ======= RENDER: Jobs (Overview) =======
function renderJobs(jobs){
  const el=document.getElementById('jobs-body');
  document.getElementById('job-count').textContent=jobs.length;
  const run=jobs.filter(j=>j.status==='running'),que=jobs.filter(j=>j.status==='queued');
  let h='';
  if(run.length){h+='<div class="job-section"><span style="color:var(--cyan)">‚ñ∂</span> Running</div>';for(const j of run){const env=resolveEnv(j);h+=`<div class="job-item" style="border-left:2px solid var(--cyan)"><div class="job-left"><span class="job-id">${j.id.slice(0,8)}</span><span>${esc(j.method)}</span><span style="font-size:.7rem;color:var(--text2)">${esc(env)}</span></div><div style="display:flex;align-items:center;gap:6px"><span style="color:var(--text2);font-size:.75rem">${dur(j.started_at)}</span><button class="btn-sm" onclick="cancelJob('${j.id}')" style="color:var(--red)">‚úï</button></div></div>`}}
  if(que.length){h+=`<div class="job-section"><span style="color:var(--accent2)">‚è≥</span> Queue (${que.length})</div>`;for(const j of que){const env=resolveEnv(j);h+=`<div class="job-item"><div class="job-left"><span class="job-id">${j.id.slice(0,8)}</span><span>${esc(j.method)}</span><span style="font-size:.7rem;color:var(--text2)">${esc(env)}</span></div><div style="display:flex;align-items:center;gap:6px"><span class="badge badge-queued">queued</span><button class="btn-sm" onclick="cancelJob('${j.id}')" style="color:var(--red)">‚úï</button></div></div>`}}
  if(!run.length&&!que.length)h='<div class="empty">No active jobs</div>';
  el.innerHTML=h;
}

function renderActivity(){
  const el=document.getElementById('activity-log');
  if(!activityLog.length){el.innerHTML='<div class="empty">Waiting‚Ä¶</div>';return}
  el.innerHTML=activityLog.slice(0,25).map(e=>`<div class="entry"><span class="time">${e.time}</span><span class="msg">${e.msg}</span></div>`).join('');
}

// ======= FETCH RESULTS =======
async function fetchResults(jobs){
  for(const j of jobs.filter(j=>j.status==='running'||j.status==='completed')){
    try{
      const r=await fetch(`/api/results/${j.id}`,{headers:{'Authorization':'Bearer '+TOKEN}});
      if(!r.ok)continue;
      const d=await r.json();
      const pts=(d.results||[]).map(row=>({
        gen:row.generation,
        best:parseFloat(row.data?.best||0),
        best_ever:parseFloat(row.data?.best_ever||row.data?.best||0),
        mean:parseFloat(row.data?.mean||0),
        sigma:parseFloat(row.data?.sigma||0),
        evals:parseInt((row.data?.evals||'0').replace(/,/g,'')),
        time:parseFloat(row.data?.time||0),
      })).sort((a,b)=>a.gen-b.gen);
      const env=resolveEnv(j);
      allJobData[j.id]={method:j.method,environment:env,status:j.status,points:pts,started_at:j.started_at,completed_at:j.completed_at};
    }catch(e){}
  }
}

// ======= LEADERBOARD =======
function renderLeaderboard(){
  const el=document.getElementById('leaderboard-body');
  const bench=BENCHMARKS[currentBenchEnv];
  if(!bench){el.innerHTML='<div class="empty">Unknown benchmark</div>';return}

  // Collect best results per method for this environment
  const methods={};
  for(const[id,d]of Object.entries(allJobData)){
    if(!d.points.length)continue;
    const env=d.environment||'LunarLander-v3';
    if(env!==currentBenchEnv)continue;
    const mKey=d.method;
    const mName=METHOD_NAMES[mKey]||METHOD_NAMES[d.method]||d.method;
    const best=Math.max(...d.points.map(p=>p.best_ever));
    const totalEvals=Math.max(...d.points.map(p=>p.evals),d.points.length);
    const runtime=d.started_at&&d.completed_at?dur(d.started_at,d.completed_at):(d.started_at?dur(d.started_at):'-');
    if(!methods[mKey]||best>methods[mKey].best){
      methods[mKey]={key:mKey,name:mName,best,evals:totalEvals,runtime,solved:best>=bench.threshold,jobId:id,status:d.status};
    }
  }

  const sorted=Object.values(methods).sort((a,b)=>b.best-a.best);
  if(!sorted.length){
    el.innerHTML=`<div class="empty">No results for ${currentBenchEnv} yet.<br>
      <span style="font-size:.7rem;color:var(--text2)">Threshold: ${bench.threshold} | obs: ${bench.obs_dim} | act: ${bench.act_dim} (${bench.action_type})</span></div>`;
    return;
  }

  let h=`<div style="font-size:.7rem;color:var(--text2);margin-bottom:8px">Solved ‚â• ${bench.threshold} | obs_dim=${bench.obs_dim} | act_dim=${bench.act_dim} (${bench.action_type})</div>`;
  h+='<table class="leaderboard"><tr><th>#</th><th>Method</th><th>Best Score</th><th>Evals</th><th>Solved?</th><th>Runtime</th><th>Status</th></tr>';
  sorted.forEach((m,i)=>{
    const isBackprop=['ppo_baseline'].includes(m.key);
    const rankClass=i<3?`rank-${i+1}`:'';
    const medal=i===0?'ü•á':i===1?'ü•à':i===2?'ü•â':'';
    const solvedBadge=m.solved?'<span style="color:var(--green)">‚úÖ</span>':'<span style="color:var(--text2)">‚Äî</span>';
    const scoreColor=m.solved?'var(--green)':m.best>bench.threshold*0.8?'var(--yellow)':'var(--text)';
    const typeBadge=isBackprop?'<span style="background:rgba(239,68,68,.15);color:var(--red);padding:1px 6px;border-radius:4px;font-size:.65rem;margin-left:4px">‚ö° BACKPROP</span>':'<span style="background:rgba(34,197,94,.12);color:var(--green);padding:1px 6px;border-radius:4px;font-size:.65rem;margin-left:4px">üß¨ GRAD-FREE</span>';
    const rowBg=isBackprop?'background:rgba(239,68,68,.04);':'';
    h+=`<tr style="${rowBg}">
      <td class="${rankClass}">${medal}${i+1}</td>
      <td style="font-weight:600">${esc(m.name)}${typeBadge}</td>
      <td style="color:${scoreColor};font-weight:700;font-variant-numeric:tabular-nums">${m.best.toFixed(1)}</td>
      <td style="font-variant-numeric:tabular-nums">${m.evals>1000?(m.evals/1000).toFixed(1)+'K':m.evals}</td>
      <td>${solvedBadge}</td>
      <td style="color:var(--text2)">${m.runtime}</td>
      <td><span class="badge badge-${m.status}">${m.status}</span></td>
    </tr>`;
  });
  h+='</table>';
  el.innerHTML=h;
}

// ======= BEST SCORES =======
function renderBestScores(){
  const el=document.getElementById('best-scores');
  // Per-environment best
  const envBest={};
  for(const d of Object.values(allJobData)){
    if(!d.points.length)continue;
    const env=d.environment||'LunarLander-v3';
    const best=Math.max(...d.points.map(p=>p.best_ever));
    if(!envBest[env]||best>envBest[env])envBest[env]=best;
  }
  if(!Object.keys(envBest).length){el.innerHTML='<div class="empty">Run experiments to see scores</div>';return}
  el.innerHTML=Object.entries(envBest).map(([env,s])=>{
    const bench=BENCHMARKS[env]||{threshold:200,emoji:'üî¨'};
    const ok=s>=bench.threshold;
    return`<div class="big-num"><div class="val ${ok?'solved':''}">${s.toFixed(1)}</div><div class="lbl">${bench.emoji} ${esc(env)}${ok?' üéâ':''}</div></div>`;
  }).join('');
}

// ======= HISTORY =======
function renderHistory(){
  const el=document.getElementById('history-body');
  const filter=document.getElementById('history-env-filter').value;
  let jobs=[...allJobs].sort((a,b)=>new Date(b.created_at)-new Date(a.created_at));
  if(filter!=='all')jobs=jobs.filter(j=>resolveEnv(j)===filter);
  if(!jobs.length){el.innerHTML='<div class="empty">No jobs</div>';return}

  let h='<table class="leaderboard"><tr><th>ID</th><th>Environment</th><th>Method</th><th>Status</th><th>Best</th><th>Queued</th><th>Started</th><th>Completed</th><th>Runtime</th><th></th></tr>';
  for(const j of jobs.slice(0,50)){
    const env=resolveEnv(j);
    const d=allJobData[j.id];
    const best=d&&d.points.length?Math.max(...d.points.map(p=>p.best_ever)).toFixed(1):'‚Äî';
    const runtime=dur(j.started_at,j.completed_at);
    h+=`<tr>
      <td style="font-family:monospace;font-size:.75rem">${j.id.slice(0,8)}</td>
      <td style="font-size:.75rem">${esc(env)}</td>
      <td>${esc(j.method)}</td>
      <td><span class="badge badge-${j.status}">${j.status}</span></td>
      <td style="font-weight:600;font-variant-numeric:tabular-nums">${best}</td>
      <td style="font-size:.7rem;color:var(--text2)">${fmtTime(j.created_at)}</td>
      <td style="font-size:.7rem;color:var(--text2)">${fmtTime(j.started_at)}</td>
      <td style="font-size:.7rem;color:var(--text2)">${fmtTime(j.completed_at)}</td>
      <td style="font-size:.7rem">${runtime}</td>
      <td><button class="btn-sm" onclick="downloadCSV('${j.id}')">CSV</button></td>
    </tr>`;
  }
  if(jobs.length>50)h+=`<tr><td colspan="10" style="text-align:center;color:var(--text2)">+${jobs.length-50} more</td></tr>`;
  h+='</table>';
  el.innerHTML=h;
}

// ======= CHARTS =======
function setMetric(btn,m){
  currentMetric=m;
  document.querySelectorAll('[data-metric]').forEach(b=>b.classList.remove('active'));
  btn.classList.add('active');
  drawLearningCurves();
}

function drawAllCharts(){drawComparison();drawSigma();drawDistribution()}

function setupCanvas(id){
  const canvas=document.getElementById(id);
  const wrap=canvas.parentElement;
  const dpr=window.devicePixelRatio||1;
  const w=wrap.clientWidth,h=wrap.clientHeight;
  canvas.width=w*dpr;canvas.height=h*dpr;
  canvas.style.width=w+'px';canvas.style.height=h+'px';
  const ctx=canvas.getContext('2d');
  ctx.scale(dpr,dpr);
  ctx.clearRect(0,0,w,h);
  return{ctx,w,h,dpr};
}

function drawGrid(ctx,pad,w,h,minY,maxY,maxX,xLabel,yLabel,steps=6){
  const pw=w-pad.left-pad.right,ph=h-pad.top-pad.bottom;
  const range=maxY-minY||1;
  ctx.strokeStyle='#1a1a2a';ctx.lineWidth=.5;
  for(let i=0;i<=steps;i++){
    const y=pad.top+(ph/steps)*i;
    ctx.beginPath();ctx.moveTo(pad.left,y);ctx.lineTo(w-pad.right,y);ctx.stroke();
    ctx.fillStyle='#666';ctx.font='9px sans-serif';ctx.textAlign='right';
    ctx.fillText((maxY-(range/steps)*i).toFixed(0),pad.left-5,y+3);
  }
  ctx.textAlign='center';ctx.fillStyle='#666';
  for(let i=0;i<=4;i++){
    const v=Math.round((maxX/4)*i);
    ctx.fillText(v,pad.left+(v/maxX)*pw,h-pad.bottom+14);
  }
  ctx.fillText(xLabel,w/2,h-2);
  ctx.save();ctx.translate(10,h/2);ctx.rotate(-Math.PI/2);ctx.fillText(yLabel,0,0);ctx.restore();
}

function drawSolvedLine(ctx,pad,w,h,minY,maxY,val){
  if(val<minY||val>maxY)return;
  const ph=h-pad.top-pad.bottom,range=maxY-minY||1;
  const y=pad.top+ph-((val-minY)/range)*ph;
  ctx.setLineDash([4,3]);ctx.strokeStyle='#22c55e40';ctx.lineWidth=1;
  ctx.beginPath();ctx.moveTo(pad.left,y);ctx.lineTo(w-pad.right,y);ctx.stroke();
  ctx.setLineDash([]);
  ctx.fillStyle='#22c55e50';ctx.font='8px sans-serif';ctx.textAlign='left';
  ctx.fillText(`SOLVED (${val})`,pad.left+4,y-3);
}

// Learning Curves ‚Äî filtered by current benchmark env, with zoom + method toggles
function buildMethodToggles(entries){
  const el=document.getElementById('method-toggles');
  const methods=new Map();
  let ci=0;
  for(const[id,d]of entries){
    if(!methods.has(d.method)){
      const color=COLORS[ci%COLORS.length];
      const name=METHOD_NAMES[d.method]||d.method;
      const isBackprop=BACKPROP_METHODS.has(d.method);
      methods.set(d.method,{name,color,isBackprop});
      ci++;
    }
  }
  el.innerHTML=[...methods.entries()].map(([key,{name,color,isBackprop}])=>{
    const checked=!hiddenMethods.has(key)?'checked':'';
    const label=isBackprop?`‚ö°${name}`:`üß¨${name}`;
    return`<label style="display:flex;align-items:center;gap:3px;cursor:pointer;opacity:${hiddenMethods.has(key)?'.4':'1'}"><input type="checkbox" ${checked} onchange="toggleMethod('${key}')" style="accent-color:${color}"><span style="color:${color}">${label}</span></label>`;
  }).join('');
}

function toggleMethod(key){
  if(hiddenMethods.has(key))hiddenMethods.delete(key);else hiddenMethods.add(key);
  drawLearningCurves();
}

function initChartZoom(){
  const canvas=document.getElementById('learning-canvas');
  canvas.addEventListener('wheel',e=>{
    e.preventDefault();
    const rect=canvas.getBoundingClientRect();
    const xFrac=(e.clientX-rect.left)/rect.width;
    const zoomRange=chartZoom.x1-chartZoom.x0;
    const center=chartZoom.x0+xFrac*zoomRange;
    const factor=e.deltaY>0?1.2:0.8;
    const newRange=Math.min(1,zoomRange*factor);
    chartZoom.x0=Math.max(0,center-xFrac*newRange);
    chartZoom.x1=Math.min(1,chartZoom.x0+newRange);
    if(chartZoom.x1-chartZoom.x0>0.99){chartZoom.x0=0;chartZoom.x1=1}
    drawLearningCurves();
  },{passive:false});
  canvas.addEventListener('dblclick',()=>{chartZoom.x0=0;chartZoom.x1=1;drawLearningCurves()});
  canvas.addEventListener('mousedown',e=>{if(e.shiftKey){chartZoom.dragging=true;chartZoom.startX=e.clientX;chartZoom.dragStart={...chartZoom}}});
  canvas.addEventListener('mousemove',e=>{
    if(!chartZoom.dragging)return;
    const rect=canvas.getBoundingClientRect();
    const dx=(e.clientX-chartZoom.startX)/rect.width*(chartZoom.dragStart.x1-chartZoom.dragStart.x0);
    const r=chartZoom.dragStart.x1-chartZoom.dragStart.x0;
    chartZoom.x0=Math.max(0,Math.min(1-r,chartZoom.dragStart.x0-dx));
    chartZoom.x1=chartZoom.x0+r;
    drawLearningCurves();
  });
  canvas.addEventListener('mouseup',()=>{chartZoom.dragging=false});
  canvas.addEventListener('mouseleave',()=>{chartZoom.dragging=false});
}
let chartZoomInited=false;

function drawLearningCurves(){
  if(!chartZoomInited){initChartZoom();chartZoomInited=true}
  const{ctx,w,h}=setupCanvas('learning-canvas');
  const bench=BENCHMARKS[currentBenchEnv]||{threshold:200};
  const allEntries=Object.entries(allJobData).filter(([_,d])=>d.points.length>0&&(d.environment||'LunarLander-v3')===currentBenchEnv);
  buildMethodToggles(allEntries);
  const entries=allEntries.filter(([_,d])=>!hiddenMethods.has(d.method));
  if(!entries.length){ctx.fillStyle='#888';ctx.font='13px sans-serif';ctx.textAlign='center';ctx.fillText(`No visible data for ${currentBenchEnv}`,w/2,h/2);return}

  const pad={top:28,right:20,bottom:36,left:56};
  const pw=w-pad.left-pad.right,ph=h-pad.top-pad.bottom;
  const allPts=entries.flatMap(([_,d])=>d.points);
  const fullMaxGen=Math.max(...allEntries.flatMap(([_,d])=>d.points).map(p=>p.gen),1);
  const visMinGen=Math.floor(chartZoom.x0*fullMaxGen);
  const visMaxGen=Math.ceil(chartZoom.x1*fullMaxGen)||1;
  const visPts=allPts.filter(p=>p.gen>=visMinGen&&p.gen<=visMaxGen);
  const vals=visPts.length?visPts.map(p=>p[currentMetric]||0):[0];
  const maxV=Math.max(Math.max(...vals),bench.threshold*1.1),minV=Math.min(Math.min(...vals),-100);
  const range=maxV-minV||1;
  const toX=g=>pad.left+((g-visMinGen)/(visMaxGen-visMinGen||1))*pw;
  const toY=v=>pad.top+ph-((v-minV)/range)*ph;

  drawGrid(ctx,pad,w,h,minV,maxV,visMaxGen,'Generation',currentMetric==='best_ever'?'Best Score Ever':'Mean Score');
  drawSolvedLine(ctx,pad,w,h,minV,maxV,bench.threshold);

  if(0>=minV&&0<=maxV){ctx.setLineDash([2,2]);ctx.strokeStyle='#fff1';ctx.lineWidth=.5;ctx.beginPath();ctx.moveTo(pad.left,toY(0));ctx.lineTo(w-pad.right,toY(0));ctx.stroke();ctx.setLineDash([])}

  // Clip to chart area
  ctx.save();ctx.beginPath();ctx.rect(pad.left,pad.top,pw,ph);ctx.clip();

  let ci=0;
  // Color index must match allEntries order for consistency with toggles
  const colorMap=new Map();let cj=0;
  for(const[_,d]of allEntries){if(!colorMap.has(d.method)){colorMap.set(d.method,COLORS[cj%COLORS.length]);cj++}}

  for(const[id,d]of entries){
    const color=colorMap.get(d.method)||COLORS[0];
    const pts=d.points.filter(p=>p.gen>=visMinGen&&p.gen<=visMaxGen);
    if(!pts.length)continue;

    // Area
    ctx.fillStyle=color+'0c';
    ctx.beginPath();ctx.moveTo(toX(pts[0].gen),toY(minV));
    pts.forEach(p=>ctx.lineTo(toX(p.gen),toY(p[currentMetric]||0)));
    ctx.lineTo(toX(pts[pts.length-1].gen),toY(minV));ctx.closePath();ctx.fill();

    // Line
    ctx.strokeStyle=color;ctx.lineWidth=2;ctx.beginPath();
    pts.forEach((p,i)=>{const x=toX(p.gen),y=toY(p[currentMetric]||0);i===0?ctx.moveTo(x,y):ctx.lineTo(x,y)});
    ctx.stroke();

    if(pts.length<50){ctx.fillStyle=color;pts.forEach(p=>{ctx.beginPath();ctx.arc(toX(p.gen),toY(p[currentMetric]||0),2.5,0,Math.PI*2);ctx.fill()})}

    const last=pts[pts.length-1];
    const v=last[currentMetric]||0;
    ctx.fillStyle=color;ctx.font='bold 10px sans-serif';ctx.textAlign='left';
    ctx.fillText(v.toFixed(1),toX(last.gen)+6,toY(v)+3);
  }
  ctx.restore(); // unclip

  // Zoom indicator
  if(chartZoom.x0>0.001||chartZoom.x1<0.999){
    ctx.fillStyle='rgba(99,102,241,0.15)';
    const zx=pad.left,zy=h-pad.bottom+20,zw=pw,zh=4;
    ctx.fillRect(zx,zy,zw,zh);
    ctx.fillStyle='var(--accent)';
    ctx.fillRect(zx+chartZoom.x0*zw,zy,((chartZoom.x1-chartZoom.x0)*zw),zh);
  }
  document.getElementById('chart1-info').textContent=`${currentBenchEnv} ¬∑ ${entries.reduce((s,[_,d])=>s+d.points.length,0)} pts`;
}

// Comparison bars (all envs)
function drawComparison(){
  const{ctx,w,h}=setupCanvas('comparison-canvas');
  const methods={};
  for(const d of Object.values(allJobData)){
    if(!d.points.length)continue;
    const env=d.environment||'LunarLander-v3';
    const name=(METHOD_NAMES[d.method]||d.method)+'\n'+env.replace('-v3','');
    const best=Math.max(...d.points.map(p=>p.best_ever));
    const lastMean=d.points[d.points.length-1].mean;
    if(!methods[name]||best>methods[name].best)methods[name]={best,mean:lastMean,env};
  }
  const names=Object.keys(methods);
  if(!names.length){ctx.fillStyle='#888';ctx.font='13px sans-serif';ctx.textAlign='center';ctx.fillText('No data yet',w/2,h/2);return}

  const pad={top:24,right:20,bottom:50,left:50};
  const pw=w-pad.left-pad.right,ph=h-pad.top-pad.bottom;
  const vals=[...Object.values(methods).map(m=>m.best),...Object.values(methods).map(m=>m.mean)];
  const maxV=Math.max(Math.max(...vals),300),minV=Math.min(Math.min(...vals),-300);
  const range=maxV-minV||1;
  const toY=v=>pad.top+ph-((v-minV)/range)*ph;

  ctx.strokeStyle='#1a1a2a';ctx.lineWidth=.5;
  for(let i=0;i<=5;i++){const y=pad.top+(ph/5)*i;ctx.beginPath();ctx.moveTo(pad.left,y);ctx.lineTo(w-pad.right,y);ctx.stroke();ctx.fillStyle='#666';ctx.font='9px sans-serif';ctx.textAlign='right';ctx.fillText((maxV-(range/5)*i).toFixed(0),pad.left-5,y+3)}

  const barW=Math.min(40,pw/(names.length*3));
  const gap=pw/(names.length);
  names.forEach((name,i)=>{
    const x=pad.left+gap*i+gap/2;
    const m=methods[name];
    const yBest=toY(m.best),yZero=toY(0);
    ctx.fillStyle='#6366f1cc';ctx.fillRect(x-barW-1,Math.min(yBest,yZero),barW,Math.abs(yBest-yZero));
    const yMean=toY(m.mean);
    ctx.fillStyle='#22c55ecc';ctx.fillRect(x+1,Math.min(yMean,yZero),barW,Math.abs(yMean-yZero));
    ctx.fillStyle='#e0e0e8';ctx.font='bold 9px sans-serif';ctx.textAlign='center';
    ctx.fillText(m.best.toFixed(0),x-barW/2,yBest-4);
    ctx.save();ctx.translate(x,h-pad.bottom+6);ctx.rotate(-Math.PI/6);
    ctx.fillStyle='#aaa';ctx.font='8px sans-serif';ctx.textAlign='right';
    const label=name.replace('\n',' ¬∑ ');
    ctx.fillText(label,0,0);ctx.restore();
  });
}

// Sigma
function drawSigma(){
  const{ctx,w,h}=setupCanvas('sigma-canvas');
  const entries=Object.entries(allJobData).filter(([_,d])=>d.points.length>0&&d.points[0].sigma>0);
  if(!entries.length){ctx.fillStyle='#888';ctx.font='13px sans-serif';ctx.textAlign='center';ctx.fillText('No sigma data',w/2,h/2);return}
  const pad={top:24,right:20,bottom:36,left:50};
  const pw=w-pad.left-pad.right,ph=h-pad.top-pad.bottom;
  const allPts=entries.flatMap(([_,d])=>d.points);
  const maxGen=Math.max(...allPts.map(p=>p.gen),1),maxS=Math.max(...allPts.map(p=>p.sigma),1)*1.1;
  const toX=g=>pad.left+(g/maxGen)*pw,toY=s=>pad.top+ph-(s/maxS)*ph;
  drawGrid(ctx,pad,w,h,0,maxS,maxGen,'Generation','œÉ (Step Size)');
  let ci=0;
  for(const[id,d]of entries){
    const color=COLORS[ci%COLORS.length];
    ctx.strokeStyle=color;ctx.lineWidth=1.5;ctx.beginPath();
    d.points.forEach((p,i)=>{i===0?ctx.moveTo(toX(p.gen),toY(p.sigma)):ctx.lineTo(toX(p.gen),toY(p.sigma))});
    ctx.stroke();
    const last=d.points[d.points.length-1];
    ctx.fillStyle=color;ctx.font='9px sans-serif';ctx.textAlign='left';
    ctx.fillText((METHOD_NAMES[d.method]||d.method)+' œÉ='+last.sigma.toFixed(4),toX(last.gen)+4,toY(last.sigma));
    ci++;
  }
}

// Distribution
function drawDistribution(){
  const{ctx,w,h}=setupCanvas('dist-canvas');
  const entries=Object.entries(allJobData).filter(([_,d])=>d.points.length>0);
  if(!entries.length){ctx.fillStyle='#888';ctx.font='13px sans-serif';ctx.textAlign='center';ctx.fillText('No data',w/2,h/2);return}
  const pad={top:24,right:20,bottom:36,left:56};
  const pw=w-pad.left-pad.right,ph=h-pad.top-pad.bottom;
  const allPts=entries.flatMap(([_,d])=>d.points);
  const maxGen=Math.max(...allPts.map(p=>p.gen),1);
  const allVals=[...allPts.map(p=>p.best_ever),...allPts.map(p=>p.mean)];
  const maxV=Math.max(...allVals)*1.1,minV=Math.min(...allVals)*1.1;
  const range=maxV-minV||1;
  const toX=g=>pad.left+(g/maxGen)*pw,toY=v=>pad.top+ph-((v-minV)/range)*ph;
  drawGrid(ctx,pad,w,h,minV,maxV,maxGen,'Generation','Score');
  let ci=0;
  for(const[id,d]of entries){
    const color=COLORS[ci%COLORS.length];
    ctx.fillStyle=color+'18';ctx.beginPath();
    d.points.forEach((p,i)=>{i===0?ctx.moveTo(toX(p.gen),toY(p.best_ever)):ctx.lineTo(toX(p.gen),toY(p.best_ever))});
    for(let i=d.points.length-1;i>=0;i--)ctx.lineTo(toX(d.points[i].gen),toY(d.points[i].mean));
    ctx.closePath();ctx.fill();
    ctx.strokeStyle=color;ctx.lineWidth=1.5;ctx.setLineDash([]);ctx.beginPath();
    d.points.forEach((p,i)=>{i===0?ctx.moveTo(toX(p.gen),toY(p.best_ever)):ctx.lineTo(toX(p.gen),toY(p.best_ever))});
    ctx.stroke();
    ctx.strokeStyle=color+'80';ctx.lineWidth=1;ctx.setLineDash([3,3]);ctx.beginPath();
    d.points.forEach((p,i)=>{i===0?ctx.moveTo(toX(p.gen),toY(p.mean)):ctx.lineTo(toX(p.gen),toY(p.mean))});
    ctx.stroke();ctx.setLineDash([]);
    const last=d.points[d.points.length-1];
    ctx.fillStyle=color;ctx.font='9px sans-serif';ctx.textAlign='left';
    ctx.fillText((METHOD_NAMES[d.method]||d.method),toX(last.gen)+4,toY(last.best_ever));
    ci++;
  }
}

// ======= ACTIONS =======
async function submitJob(){
  const environment=document.getElementById('env-select').value;
  const method=document.getElementById('method-select').value;
  const maxEvals=parseInt(document.getElementById('max-evals-input').value)||5000;
  try{
    const r=await fetch('/api/jobs/submit',{method:'POST',headers:{'Authorization':'Bearer '+TOKEN,'Content-Type':'application/json'},body:JSON.stringify({method,environment,max_evals:maxEvals,params:{max_evals:maxEvals}})});
    if(r.ok){addLog(`üì§ Submitted: <b>${esc(method)}</b> on <b>${esc(environment)}</b> (${maxEvals} evals)`);refresh()}
  }catch(e){addLog('‚ùå Submit failed')}
}

async function cancelJob(jobId){
  if(!confirm('Cancel job '+jobId.slice(0,8)+'?'))return;
  try{await fetch(`/api/jobs/cancel/${jobId}`,{method:'POST',headers:{'Authorization':'Bearer '+TOKEN}});addLog('üö´ Cancelled job <b>'+jobId.slice(0,8)+'</b>');refresh()}catch(e){addLog('‚ùå Cancel failed')}
}

async function toggleWorker(workerId){
  try{const r=await fetch(`/api/workers/${workerId}/enable`,{method:'POST',headers:{'Authorization':'Bearer '+TOKEN}});const d=await r.json();addLog(d.enabled?'‚ñ∂Ô∏è Worker enabled':'‚è∏ Worker disabled');refresh()}catch(e){addLog('‚ùå Toggle failed')}
}

async function forceUpdate(workerId){
  if(!confirm('Force update this worker?'))return;
  try{await fetch(`/api/workers/${workerId}/force-update`,{method:'POST',headers:{'Authorization':'Bearer '+TOKEN}});addLog('üîÑ Force update sent');refresh()}catch(e){addLog('‚ùå Force update failed')}
}

// ======= DATA EXPORT =======
async function downloadCSV(jobId){
  try{const r=await fetch(`/api/results/${jobId}/csv`,{headers:{'Authorization':'Bearer '+TOKEN}});const text=await r.text();dl(text,'text/csv',`gaia-${jobId.slice(0,8)}.csv`)}catch(e){}
}

async function downloadAllCSV(){
  let csv='job_id,method,environment,generation,best,best_ever,mean,sigma,evals,time\n';
  for(const[id,d]of Object.entries(allJobData)){
    for(const p of d.points)csv+=`${id.slice(0,8)},${d.method},${d.environment||'LunarLander-v3'},${p.gen},${p.best},${p.best_ever},${p.mean},${p.sigma},${p.evals},${p.time}\n`;
  }
  dl(csv,'text/csv','gaia-all-results.csv');
}

function downloadSummaryJSON(){
  const summary={};
  for(const[id,d]of Object.entries(allJobData)){
    if(!d.points.length)continue;
    const key=(METHOD_NAMES[d.method]||d.method)+'@'+(d.environment||'LunarLander-v3');
    summary[key]={job_id:id,method:d.method,environment:d.environment||'LunarLander-v3',status:d.status,
      generations:d.points.length,best_ever:Math.max(...d.points.map(p=>p.best_ever)),
      final_mean:d.points[d.points.length-1].mean,total_evals:Math.max(...d.points.map(p=>p.evals))};
  }
  dl(JSON.stringify(summary,null,2),'application/json','gaia-summary.json');
}

function dl(content,type,name){const a=document.createElement('a');a.href=URL.createObjectURL(new Blob([content],{type}));a.download=name;a.click()}

// ======= DEBUG =======
const debugLog=[],MAX_DEBUG=500;
function addDebug(msg){debugLog.push({time:new Date().toLocaleTimeString('en',{hour12:false,hour:'2-digit',minute:'2-digit',second:'2-digit'}),msg});if(debugLog.length>MAX_DEBUG)debugLog.shift()}
function renderDebug(){
  const el=document.getElementById('debug-log');if(!el)return;
  if(!debugLog.length){el.textContent='Waiting for data‚Ä¶';return}
  el.innerHTML=debugLog.map(e=>`<span style="color:var(--text2)">${e.time}</span> ${e.msg}`).join('\n');
  if(document.getElementById('debug-autoscroll')?.checked)el.scrollTop=el.scrollHeight;
}
async function refreshDebugRaw(){
  try{const r=await fetch('/api/status',{headers:{'Authorization':'Bearer '+TOKEN}});const d=await r.json();document.getElementById('debug-raw').textContent=JSON.stringify(d,null,2)}catch(e){document.getElementById('debug-raw').textContent='Error: '+e}
}

// Feed debug log from refresh
const _origRefresh=refresh;
refresh=async function(){
  await _origRefresh();
  for(const[id,d]of Object.entries(allJobData)){
    if(d.status!=='running'||!d.points.length)continue;
    const last=d.points[d.points.length-1];
    const key='debug_'+id+'_'+last.gen;
    if(!window._debugSeen)window._debugSeen=new Set();
    if(!window._debugSeen.has(key)){
      window._debugSeen.add(key);
      addDebug(`<span style="color:var(--cyan)">[${d.method}@${d.environment||'?'}]</span> Gen ${last.gen} | best: ${last.best_ever.toFixed(1)} | mean: ${last.mean.toFixed(1)} | œÉ: ${last.sigma.toFixed(4)} | evals: ${last.evals}`);
    }
  }
  if(document.getElementById('tab-debug')?.classList.contains('active'))renderDebug();
  if(document.getElementById('tab-history')?.classList.contains('active'))renderHistory();
};

// ======= NETWORK =======
async function renderNetwork(){
  const el=document.getElementById('network-body');
  try{
    const r=await fetch('/api/network',{headers:{'Authorization':'Bearer '+TOKEN}});
    if(!r.ok)throw new Error('HTTP '+r.status);
    const d=await r.json();
    if(d.mode==='centralized'){
      el.innerHTML=`<div style="text-align:center;padding:40px"><div style="font-size:3rem;margin-bottom:16px">üèóÔ∏è</div><h3 style="margin-bottom:8px">Centralized Mode</h3><p style="color:var(--text2);font-size:.875rem">Start with <code style="background:var(--surface2);padding:2px 6px;border-radius:4px">--gossip</code> to enable P2P.</p></div>`;
      return;
    }
    let h=`<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:12px;margin-bottom:20px">
      <div class="big-num"><div class="val" style="color:var(--accent)">${d.peer_count}</div><div class="lbl">Peers</div></div>
      <div class="big-num"><div class="val" style="color:var(--green)">${d.gpu_nodes}</div><div class="lbl">GPU Nodes</div></div>
      <div class="big-num"><div class="val" style="color:var(--cyan)">${d.total_cpu_cores}</div><div class="lbl">Total CPU Cores</div></div>
    </div>`;
    if(d.peers&&d.peers.length){
      h+='<table class="leaderboard"><tr><th>Node</th><th>Address</th><th>GPU</th><th>CPU</th><th>Last Seen</th></tr>';
      for(const p of d.peers){const c=p.capabilities||{};h+=`<tr><td style="color:var(--accent)">${esc(p.node_id.slice(0,12))}...</td><td>${esc(p.address)}</td><td>${c.gpu?'üü¢ '+esc(c.gpu):'‚Äî'}</td><td>${c.cpu_cores||'?'} cores</td><td>${timeSince(p.last_seen)}</td></tr>`}
      h+='</table>';
    }
    el.innerHTML=h;
  }catch(e){el.innerHTML=`<div class="empty">Network unavailable: ${esc(e.message)}</div>`}
}

// Hook network tab
const _origRefresh2=refresh;
refresh=async function(){
  await _origRefresh2();
  if(document.getElementById('tab-network')?.classList.contains('active'))renderNetwork();
};

window.addEventListener('resize',()=>{
  if(document.getElementById('tab-benchmarks').classList.contains('active'))drawLearningCurves();
  if(document.getElementById('tab-charts').classList.contains('active'))drawAllCharts();
});
</script>
</body>
</html>
